{"version":3,"sources":["../../src/controller/users.js"],"names":["config","db","api","post","req","res","newUser","userName","body","uEmail","uPwd","uAddress","uPhoneNumber","uProfilePic","status","userType","save","err","send","json","message","get","find","users","findById","params","id","user","put","newCard","cardLastFour","last4","cardToken","token","cardStatus","userID","card","cards","push","promoID","promos","indexOf","console","log","_id","accnt","accountUsersArray","accountStoreArray","stores","length","storeID","newComment","comment","comments","userJSON","name","email","userEmail","phone","userPhone","phone2","receiver","address","userAddress","address2","city","state","zip"],"mappings":"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","file":"users.js","sourcesContent":["import mongoose from 'mongoose';\nimport { Router } from 'express';\nimport User from '../model/user';\nimport {authenticate} from '../middleware/authMiddleware';\nimport Account from '../model/account';\nimport Card from '../model/card';\nimport Promo from '../model/promo';\nimport Comment from '../model/offerComment';\nimport cnkt from '../middleware/conektaManager';\n\nexport default({config,db})=>{\n  let api = Router();\n\n  //v1/user/add\n  api.post('/add', authenticate,(req, res)=>{\n      let newUser = User();\n      newUser.userName = req.body.userName;\n      newUser.uEmail = req.body.uEmail;\n      newUser.uPwd = req.body.uPwd;\n      newUser.uAddress = req.body.uAddress;\n      newUser.uPhoneNumber = req.body.uPhoneNumber;\n      newUser.uProfilePic = req.body.uProfilePic;\n      newUser.status = 0;\n      newUser.userType = req.body.userType;\n\n      newUser.save(err => {\n        if(err){\n          res.send(err);\n        }\n        res.json({message: 'User created successfully!'});\n      });\n    });\n\n\n  //v1/user/ -> GET all users\n  api.get('/', (req, res)=>{\n    User.find({}, (err, users)=>{\n      if(err){\n        res.send(err);\n      }\n      res.json({users});\n    });\n  });\n\n  //v1/user/:id -> GET user by id\n  api.get('/:id', authenticate, (req, res)=>{\n    User.findById(req.params.id, (err, user)=>{\n      if(err){\n        res.send(err);\n      }\n      res.json({user});\n    });\n  });\n\n  //v1/user/id\n  api.put('/:id', authenticate, (req, res)=>{\n    User.findById(req.params.id, (err, user)=>{\n      if(err){\n        res.send(err);\n      }\n      user.userName = req.body.userName;\n      user.uEmail = req.body.uEmail;\n      user.uPwd = req.body.uPwd;\n      user.uAddress = req.body.uAddress;\n      user.uPhoneNumber = req.body.uPhoneNumber;\n      user.uProfilePic = req.body.uProfilePic;\n      user.status = 0;\n      user.userType = req.body.userType;\n      user.save(function (err){\n        if(err){\n          res.send(err);\n        }\n        res.json({message:\"User info updated\"});\n      });\n    });\n  });\n\n//add a card to an specific user id 'v1/user/card/add/:id'\napi.post('/card/add/:id', authenticate,(req, res)=>{\n  User.findById(req.params.id, (err, user)=>{\n    if(err){\n      res.send(err);\n    }\n\n    let newCard = new Card();\n    newCard.cardLastFour = req.body.last4;\n    newCard.cardToken = req.body.token;\n    newCard.cardStatus = 1;\n    newCard.userID = user.id;\n\n    newCard.save((err, card) =>{\n      if(err){\n        res.send(err);\n      }\n      user.cards.push(newCard);\n      user.save(err => {\n        if(err){\n          res.send(err);\n        }\n        res.json({message: 'Card added to the user'});\n      });\n    });\n  });\n});\n\n//add a liked promo to an speceific user id 'v1/user/promo/add/:id'\napi.post('/promo/add/:id', (req, res)=>{\n  User.findById(req.params.id, (err, user)=>{\n    if(err){\n      res.send(err);\n    }\n    let promoID = req.body.promoID;    \n    if(user.promos.indexOf(promoID) > -1){\n      res.json({message:'already liked by this user'});\n    }else{\n      user.promos.push(promoID);\n      user.save(err => {\n        if(err){\n          res.send(err);\n        }\n        console.log(user._id);\n        res.json({message:'promo liked by user'});\n      });\n    }\n  });\n});\n//promos liked by user id 'v1/user/promos/likedByUser/:id'\napi.get('/promos/likedByUser/:id', (req,res)=>{\n  User.findById(req.params.id, (err, user)=>{\n    if(err){\n      res.send(err);\n    }\n    if(user != null){\n      res.json({promos: user.promos});\n    }else{\n      res.json({message:'User not found'});\n    }\n  });\n});\n//Show user ID for a logged in user/account --- v1/user/account/id\napi.get('/account/:id', (req,res)=>{\n  console.log(\"entro aquí\");\n  Account.findById(req.params.id, (err,accnt)=>{\n    if(err){\n      res.send(err);\n      console.log(accnt);\n    }\n    if(accnt != null){\n      console.log(accnt);\n      let accountUsersArray = accnt.users;\n      let accountStoreArray = accnt.stores;\n      if(accountUsersArray.length != 0){\n        res.json({userID:accnt.users});\n      }else if(accountStoreArray.length != 0){\n        res.json({storeID:accnt.stores});\n      }else{\n        res.json({message:\"No user found\"})\n      }\n    }else{\n      res.json({message:\"No user found\"})\n    }\n  });\n});\n//add a comment to a promo bu user ID 'v1/user/promo/add/comment:id'\napi.post('/promo/add/comment/:id', (req, res)=>{\n  User.findById(req.params.id, (err, user)=>{\n    if(err){\n      res.send(err);\n    }\n    let newComment = new Comment();\n    newComment.comment = req.body.comment;\n\n    newComment.save((err,res)=>{\n      if(err){\n        res.send(err)\n      }\n      user.comments.push(newComment);\n      user.save(err => {\n        if(err){\n          res.send(err);\n        }\n        res.json({message: 'Comment added to the offer'});\n      });\n    });  \n  });\n});\n\n//Create conekta user\napi.post('/createConektaUser/:id', authenticate, (req,res)=>{\n  User.findById(req.params.id, (err,user)=>{\n    if(err){\n      res.json({message:'No user found'});\n    }\n    let userJSON ={\n      name:req.body.userName,\n      email:req.body.userEmail,\n      phone:req.body.userPhone,\n      token:req.body.cardToken,\n      phone2:req.body.userPhone,\n      receiver:'NA',\n      address:req.body.userAddress,\n      address2:'NA',\n      city:'NA',\n      state:'NA',\n      zip:req.body.zip\n    }\n    console.log(user.cards[0])\n    res.json(user);\n    //cnkt.cnktExecute('clienteNuevo',userJSON);\n  });\n});\n\n  return api;\n}\n"]}