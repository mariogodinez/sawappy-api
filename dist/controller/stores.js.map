{"version":3,"sources":["../../src/controller/stores.js"],"names":["nodemailer","require","config","db","api","post","req","res","newStore","name","body","address","geometry","coordinates","lat","long","userType","storePhoneNumber","about","comments","status","save","err","send","json","message","get","find","stores","findById","params","id","store","put","delete","remove","_id","myDate","Date","newPromo","title","description","startDate","endDate","price","restriction","category","images","promo","promos","push","text","userID","user","newReview","review","users","reviews","insideItem","reviewsArray","storeReviews","counter","callback","forEach","element","length"],"mappings":"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","file":"stores.js","sourcesContent":["import mongoose from 'mongoose';\nimport { Router } from 'express';\nimport Store from '../model/store';\nimport Promo from '../model/promo';\nimport StoreReview from '../model/storeReview';\nimport User from '../model/user';\nimport {authenticate} from '../middleware/authMiddleware';\nvar nodemailer = require('nodemailer');\nimport cnkt from '../middleware/conektaManager';\n\nexport default({config,db})=>{\n  let api = Router();\n\n  //v1/store/add\n  api.post('/add', authenticate, (req, res)=>{\n    let newStore = Store();\n    newStore.name = req.body.name;\n    newStore.address = req.body.address;\n    newStore.geometry.coordinates.lat = req.body.geometry.coordinates.lat;\n    newStore.geometry.coordinates.long = req.body.geometry.coordinates.long;\n    newStore.userType = req.body.userType;\n    newStore.storePhoneNumber = req.body.storePhoneNumber;\n    newStore.about = req.body.about;\n    newStore.comments = req.body.comments;\n    newStore.status = req.body.status;\n\n    newStore.save(err => {\n      if(err){\n        res.send(err);\n      }\n      res.json({message: 'Store added!!!'});\n    });\n  });\n\n//GET 'v1/store'\n  api.get('/', (req, res)=>{\n    Store.find({}, (err, stores)=>{\n      if(err){\n        res.send(err);\n      }      \n      //Test to create client, delete this before right implementation.\n      //let dataObj = '{\"name\":\"David\",\"email\":\"david.sahagun@outlook.com\",\"phone\":\"3332008159\",\"token\":\"tok_2hDz5msKwrNgbG55M\",\"phone2\":\"3332008159\",\"receiver\":\"Celia Mayorga\",\"streets\":\"esq con Librado M. Diaz\",\"address\":\"San Isidro #49\",\"address2\":\"##\",\"city\":\"Ocotlan\",\"state\":\"JAL\",\"zip\":\"47900\"}';\n      //cnkt.cnktExecute('clienteNuevo',dataObj);\n      //let dataObj = '{\"customerID\":\"cus_2hY9X4hvQmEtnC2VX\",\"product\":\"testPurchase\",\"price\":\"30000\",\"quantity\":\"1\",\"cardToken\":\"tok_2hYAwiqYQ8aGDNyU4\"}'\n      //cnkt.cnktExecute('processPayment',dataObj);\n      //let dataObj = '{\"customerCnktID\":\"cus_2hY9X4hvQmEtnC2VX\",\"cardToken\":\"tok_2hYAwiqYQ8aGDNyU4\"}';\n      //cnkt.cnktExecute('addCardToClient',dataObj);\n      res.json({stores});\n    });\n  });\n\n//GET by id 'v1/store/:id'\napi.get('/:id', authenticate, (req, res)=>{\n  Store.findById(req.params.id, (err, store)=>{\n    if(err){\n      res.send(err);\n    }\n    res.json({store});\n  });\n});\n\n//UPDATE 'v1/store/'\napi.put('/:id', authenticate, (req, res)=>{\n  Store.findById(req.params.id, (err, store)=>{\n    if(err){\n      res.send(err);\n    }\n    store.name = req.body.name;\n    store.address = req.body.address;\n    store.geometry.coordinates.lat = req.body.geometry.coordinates.lat;\n    store.geometry.coordinates.long = req.body.geometry.coordinates.long;\n    store.status = req.body.status;\n    store.save(function (err){\n      if(err){\n        res.send(err);\n      }\n      res.json({message:\"Store info updated\"});\n    });\n  });\n});\n\n//DELETE 'v1/store/:id'\napi.delete('/:id', authenticate,(req, res) => {\n  Store.findById(req.params.id, (err, store) => {\n    if(err){\n      res.json({message:\"NO DELETED BAD ID\"});\n      return;\n    }\n    if (store === null){\n      res.json({message:\"STORE NOT FOUND\"});\n      return;\n    }\n    Store.remove({\n      _id: req.params.id\n    },(err, store) => {\n      if(err){\n        res.send(err);\n      }\n      res.json({message:\"Store removed\"});\n    });\n  });\n});\n\n//add a promo to an specific store id 'v1/store/promo/add/:id'\napi.post('/promo/add/:id', authenticate, (req, res)=>{\n  Store.findById(req.params.id, (err, store)=>{\n    if(err){\n      res.send(err);\n    }\n    var myDate = new Date();\n    let newPromo = new Promo();\n    newPromo.title = req.body.title;\n    newPromo.description = req.body.description;    \n    newPromo.startDate = req.body.startDate;//Date();\n    newPromo.endDate = req.body.endDate;//myDate.setDate(myDate.getDate()+30);    \n    newPromo.price = req.body.price;\n    newPromo.restriction = req.body.restriction;\n    newPromo.category = req.body.category;\n    newPromo.images = req.body.images;\n    newPromo.store = store._id;\n\n    newPromo.save((err, promo) =>{\n      if(err){\n        res.send(err);\n      }\n      store.promos.push(newPromo);\n      store.save(err => {\n        if(err){\n          res.send(err);\n        }\n        res.json({message: 'Promo added to the store'});\n      });\n    });\n  });\n});\n\n//get promos for an specific store id\n// 'v1/store/promos/:id'\napi.get('/promos/:id', authenticate,(req, res) => {\n  Promo.find({store: req.params.id}, (err, promos)=>{\n    if(err){\n      res.send(err);\n    }\n    res.json(promos);\n  });\n});\n\n//update a promo 'v1/store/promos/:id'\napi.put('/promos/:id', authenticate, (req, res)=>{\n  Promo.find({promos: req.params.id}, (err, promos)=>{\n    if(err){\n      res.send(err);\n    }\n    promos.title = req.body.title;\n    promos.text = req.body.text;\n    promos.price = req.body.price;\n  });\n});\n\n//add a review to an specific store 'v1/store/add/review/:id'\napi.post('/add/review/:id', authenticate, (req, res)=>{\n  Store.findById(req.params.id, (err,store)=>{\n    if(err){\n      res.send(err);\n    }\n    User.findById(req.body.userID, (err, user)=>{\n      if(err){\n        res.send(err);\n      }\n      let newReview = StoreReview();\n      newReview.review = req.body.review;\n      newReview.users = user._id;\n      newReview.save(err=>{\n        if(err){\n          res.send(err);\n        }\n        store.reviews.push(newReview._id);\n        user.reviews.push(newReview._id);\n        store.save(err=>{\n          if(err){\n            res.send(err);\n          }\n          user.save(err=>{\n            if(err){\n              res.send(err);\n            }\n          });\n        });\n        res.json({message:'Review added to an store'});\n      });\n    });\n  });\n});\n// v1/store/review/:id\napi.get('/review/:id', authenticate, (req, res)=>{\n  var insideItem;\n  var reviewsArray = [];\n  var storeReviews = [];\n  var counter = 0;\n  Store.findById(req.params.id, (err, store)=>{\n    if(err){\n      res.send(err);\n    }         \n    reviewsArray = store.reviews;    \n    function callback () {\n    res.json({storeReviews});\n  }\n      reviewsArray.forEach(element => {\n        StoreReview.findById(element, (err, review)=>{\n          if(err){\n            res.send(err);\n          }          \n          insideItem = review.review+\"*\"+review.users;              \n          storeReviews.push(insideItem);\n          counter = counter +1;\n          if(counter === reviewsArray.length) {\n            callback();\n          }\n\n        });\n      });\n  });\n});\n\n  return api;\n}\n"]}