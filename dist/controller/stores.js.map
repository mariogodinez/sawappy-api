{"version":3,"sources":["../../src/controller/stores.js"],"names":["nodemailer","require","config","db","api","post","req","res","newStore","name","body","address","geometry","coordinates","lat","long","userType","storePhoneNumber","about","comments","status","save","err","send","json","message","get","mesage","find","stores","findById","params","id","store","put","delete","remove","_id","myDate","Date","newPromo","title","description","startDate","endDate","price","restriction","category","images","promo","promos","push","text","userID","user","newReview","review","users","reviews","insideItem","reviewsArray","storeReviews","counter","callback","forEach","element","length"],"mappings":"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","file":"stores.js","sourcesContent":["import mongoose from 'mongoose';\nimport { Router } from 'express';\nimport Store from '../model/store';\nimport Promo from '../model/promo';\nimport StoreReview from '../model/storeReview';\nimport User from '../model/user';\nimport {authenticate} from '../middleware/authMiddleware';\nvar nodemailer = require('nodemailer');\nimport cnkt from '../middleware/conektaManager';\n\nexport default({config,db})=>{\n  let api = Router();\n\n  //v1/store/add\n  api.post('/add', authenticate, (req, res)=>{\n    let newStore = Store();\n    newStore.name = req.body.name;\n    newStore.address = req.body.address;\n    newStore.geometry.coordinates.lat = req.body.geometry.coordinates.lat;\n    newStore.geometry.coordinates.long = req.body.geometry.coordinates.long;\n    newStore.userType = req.body.userType;\n    newStore.storePhoneNumber = req.body.storePhoneNumber;\n    newStore.about = req.body.about;\n    newStore.comments = req.body.comments;\n    newStore.status = req.body.status;\n\n    newStore.save(err => {\n      if(err){\n        res.send(err);\n      }\n      res.json({message: 'Store added!!!'});\n    });\n  });\n\n//GET 'v1/store'\n  api.get('/', (req, res)=>{\n    res.send({mesage: 'hola'})\n    Store.find({}, (err, stores)=>{\n      if(err){\n        res.send(err);\n      }      \n      //Test to create client, delete this before right implementation.\n      //let dataObj = '{\"name\":\"David\",\"email\":\"david.sahagun@outlook.com\",\"phone\":\"3332008159\",\"token\":\"tok_2hDz5msKwrNgbG55M\",\"phone2\":\"3332008159\",\"receiver\":\"Celia Mayorga\",\"streets\":\"esq con Librado M. Diaz\",\"address\":\"San Isidro #49\",\"address2\":\"##\",\"city\":\"Ocotlan\",\"state\":\"JAL\",\"zip\":\"47900\"}';\n      //cnkt.cnktExecute('clienteNuevo',dataObj);\n      //let dataObj = '{\"customerID\":\"cus_2hY9X4hvQmEtnC2VX\",\"product\":\"testPurchase\",\"price\":\"30000\",\"quantity\":\"1\",\"cardToken\":\"tok_2hYAwiqYQ8aGDNyU4\"}'\n      //cnkt.cnktExecute('processPayment',dataObj);\n      //let dataObj = '{\"customerCnktID\":\"cus_2hY9X4hvQmEtnC2VX\",\"cardToken\":\"tok_2hYAwiqYQ8aGDNyU4\"}';\n      //cnkt.cnktExecute('addCardToClient',dataObj);\n      res.json({stores});\n    });\n  });\n\n//GET by id 'v1/store/:id'\napi.get('/:id', authenticate, (req, res)=>{\n  Store.findById(req.params.id, (err, store)=>{\n    if(err){\n      res.send(err);\n    }\n    res.json({store});\n  });\n});\n\n//UPDATE 'v1/store/'\napi.put('/:id', authenticate, (req, res)=>{\n  Store.findById(req.params.id, (err, store)=>{\n    if(err){\n      res.send(err);\n    }\n    store.name = req.body.name;\n    store.address = req.body.address;\n    store.geometry.coordinates.lat = req.body.geometry.coordinates.lat;\n    store.geometry.coordinates.long = req.body.geometry.coordinates.long;\n    store.status = req.body.status;\n    store.save(function (err){\n      if(err){\n        res.send(err);\n      }\n      res.json({message:\"Store info updated\"});\n    });\n  });\n});\n\n//DELETE 'v1/store/:id'\napi.delete('/:id', authenticate,(req, res) => {\n  Store.findById(req.params.id, (err, store) => {\n    if(err){\n      res.json({message:\"NO DELETED BAD ID\"});\n      return;\n    }\n    if (store === null){\n      res.json({message:\"STORE NOT FOUND\"});\n      return;\n    }\n    Store.remove({\n      _id: req.params.id\n    },(err, store) => {\n      if(err){\n        res.send(err);\n      }\n      res.json({message:\"Store removed\"});\n    });\n  });\n});\n\n//add a promo to an specific store id 'v1/store/promo/add/:id'\napi.post('/promo/add/:id', authenticate, (req, res)=>{\n  Store.findById(req.params.id, (err, store)=>{\n    if(err){\n      res.send(err);\n    }\n    var myDate = new Date();\n    let newPromo = new Promo();\n    newPromo.title = req.body.title;\n    newPromo.description = req.body.description;    \n    newPromo.startDate = req.body.startDate;//Date();\n    newPromo.endDate = req.body.endDate;//myDate.setDate(myDate.getDate()+30);    \n    newPromo.price = req.body.price;\n    newPromo.restriction = req.body.restriction;\n    newPromo.category = req.body.category;\n    newPromo.images = req.body.images;\n    newPromo.store = store._id;\n\n    newPromo.save((err, promo) =>{\n      if(err){\n        res.send(err);\n      }\n      store.promos.push(newPromo);\n      store.save(err => {\n        if(err){\n          res.send(err);\n        }\n        res.json({message: 'Promo added to the store'});\n      });\n    });\n  });\n});\n\n//get promos for an specific store id\n// 'v1/store/promos/:id'\napi.get('/promos/:id', authenticate,(req, res) => {\n  Promo.find({store: req.params.id}, (err, promos)=>{\n    if(err){\n      res.send(err);\n    }\n    res.json(promos);\n  });\n});\n\n//update a promo 'v1/store/promos/:id'\napi.put('/promos/:id', authenticate, (req, res)=>{\n  Promo.find({promos: req.params.id}, (err, promos)=>{\n    if(err){\n      res.send(err);\n    }\n    promos.title = req.body.title;\n    promos.text = req.body.text;\n    promos.price = req.body.price;\n  });\n});\n\n//add a review to an specific store 'v1/store/add/review/:id'\napi.post('/add/review/:id', authenticate, (req, res)=>{\n  Store.findById(req.params.id, (err,store)=>{\n    if(err){\n      res.send(err);\n    }\n    User.findById(req.body.userID, (err, user)=>{\n      if(err){\n        res.send(err);\n      }\n      let newReview = StoreReview();\n      newReview.review = req.body.review;\n      newReview.users = user._id;\n      newReview.save(err=>{\n        if(err){\n          res.send(err);\n        }\n        store.reviews.push(newReview._id);\n        user.reviews.push(newReview._id);\n        store.save(err=>{\n          if(err){\n            res.send(err);\n          }\n          user.save(err=>{\n            if(err){\n              res.send(err);\n            }\n          });\n        });\n        res.json({message:'Review added to an store'});\n      });\n    });\n  });\n});\n// v1/store/review/:id\napi.get('/review/:id', authenticate, (req, res)=>{\n  var insideItem;\n  var reviewsArray = [];\n  var storeReviews = [];\n  var counter = 0;\n  Store.findById(req.params.id, (err, store)=>{\n    if(err){\n      res.send(err);\n    }         \n    reviewsArray = store.reviews;    \n    function callback () {\n    res.json({storeReviews});\n  }\n      reviewsArray.forEach(element => {\n        StoreReview.findById(element, (err, review)=>{\n          if(err){\n            res.send(err);\n          }          \n          insideItem = review.review+\"*\"+review.users;              \n          storeReviews.push(insideItem);\n          counter = counter +1;\n          if(counter === reviewsArray.length) {\n            callback();\n          }\n\n        });\n      });\n  });\n});\n\n  return api;\n}\n"]}