{"version":3,"sources":["../../src/controller/promos.js"],"names":["config","db","api","get","req","res","find","err","promos","send","json","findById","params","id","promo","put","title","body","text","status","startDate","endDate","price","save","message","post","userID","user","_id","newComment","comment","users","push","comments","insideItem","commentsArray","promoComments","counter","callback","forEach","element","console","log","length"],"mappings":"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","file":"promos.js","sourcesContent":["import mongoose from 'mongoose';\nimport { Router } from 'express';\nimport Promo from '../model/promo';\nimport OfferComment from '../model/offerComment';\nimport User from '../model/user';\nimport Comment from '../model/offerComment';\nimport {authenticate} from '../middleware/authMiddleware';\n\nexport default({config,db})=>{\n  let api = Router();\n\n  //GET 'v1/promo'\n    api.get('/', (req, res)=>{\n      Promo.find({}, (err, promos)=>{\n        if(err){\n          res.send(err);\n        }\n        res.json({promos});\n      });\n    });\n\n    //GET by id 'v1/promo/:id'\n    api.get('/:id', authenticate, (req, res)=>{\n      Promo.findById(req.params.id, (err, promo)=>{\n        if(err){\n          res.send(err);\n        }\n        res.json({promo});\n      });\n    });\n\n    //UPDATE 'v1/promo/:id'\n    api.put('/:id', authenticate, (req, res)=>{\n      Promo.findById(req.params.id, (err, promo)=>{\n        if(err){\n          res.send(err);\n        }\n        promo.title = req.body.title;\n        promo.text = req.body.text;\n        promo.status = req.body.status;\n        promo.startDate = req.body.startDate;\n        promo.endDate = req.body.endDate;\n        promo.price = req.body.price;\n        \n        promo.save(function (err){\n          if(err){\n            res.send(err);\n          }\n          res.json({message:\"Promo info updated\"});\n        });\n      });\n    });\n    //Add a comment for a promo 'v1/promo/add/comment/:id'\n    api.post('/add/comment/:id', authenticate, (req, res)=>{\n      var userID = \"\";\n      Promo.findById(req.params.id, (err, promo)=>{\n        if(err){\n          res.send(err);\n        }\n        User.findById(req.body.userID, (err, user)=>{\n          if(err){\n            res.json({message:'No user found'})\n          }\n          userID = user._id;\n        \n        let newComment = OfferComment();\n        newComment.comment = req.body.comment;\n        newComment.users.push(userID);\n        newComment.promos.push(req.params.id);\n        newComment.save(err =>{\n          if(err){\n            res.send(err);\n          }\n          user.comments.push(newComment);\n          user.save(err=>{\n            if(err){\n              res.send(err);\n            }\n            promo.comments.push(newComment._id);\n            promo.save(err=>{\n              if(err){\n                res.send(err);\n              }\n            });\n            res.json({message:'Comment added to a promo'});\n          });\n        });\n      });\n      });\n    });\n\n    //get an specific promo review 'v1/promo/comment/:id'\n    api.get('/comment/:id', authenticate, (req, res)=>{\n      var insideItem;\n      var commentsArray = [];\n      var promoComments = [];\n      var counter = 0;\n      Promo.findById(req.params.id, (err, promo)=>{\n        if(err){\n          res.send(err);\n        }     \n        commentsArray = promo.comments;\n        function callback () {\n        res.json({promoComments});\n      }\n          commentsArray.forEach(element => {\n            Comment.findById(element, (err, comment)=>{\n              if(err){\n                res.send(err);\n              }\n              insideItem = comment.comment+\"*\"+comment.users;              \n              promoComments.push(insideItem);\n              console.log(promoComments); \n              counter = counter +1;\n              if(counter === commentsArray.length) {\n                callback();\n              }\n\n            });\n          });\n      });\n    });\n\n    return api;\n}\n"]}