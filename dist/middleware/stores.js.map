{"version":3,"sources":["../../src/middleware/stores.js"],"names":["nodemailer","require","config","db","api","post","req","res","newStore","name","body","address","geometry","coordinates","lat","long","save","err","send","json","message","get","find","stores","findById","params","id","store","put","delete","remove","_id","myDate","Date","newPromo","title","text","active","startDate","endDate","setDate","getDate","promo","promos","push"],"mappings":"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","file":"stores.js","sourcesContent":["import mongoose from 'mongoose';\nimport { Router } from 'express';\nimport Store from '../model/store';\nimport Promo from '../model/promo';\nimport {authenticate} from '../middleware/authMiddleware';\nvar nodemailer = require('nodemailer');\n\nexport default({config,db})=>{\n  let api = Router();\n\n  //v1/store/add\n  api.post('/add', authenticate, (req, res)=>{\n    let newStore = Store();\n    newStore.name = req.body.name;\n    newStore.address = req.body.address;\n    newStore.geometry.coordinates.lat = req.body.geometry.coordinates.lat;\n    newStore.geometry.coordinates.long = req.body.geometry.coordinates.long;\n\n    newStore.save(err => {\n      if(err){\n        res.send(err);\n      }\n      res.json({message: 'Store added!!!'});\n    });\n  });\n\n//GET 'v1/store'\n  api.get('/', (req, res)=>{\n    Store.find({}, (err, stores)=>{\n      if(err){\n        res.send(err);\n      }\n      res.json({stores});\n    });\n  });\n\n//GET by id 'v1/store/:id'\napi.get('/:id', authenticate, (req, res)=>{\n  Store.findById(req.params.id, (err, store)=>{\n    if(err){\n      res.send(err);\n    }\n    res.json({store});\n  });\n});\n\n//UPDATE 'v1/store/'\napi.put('/:id', authenticate, (req, res)=>{\n  Store.findById(req.params.id, (err, store)=>{\n    if(err){\n      res.send(err);\n    }\n    store.name = req.body.name;\n    store.address = req.body.address;\n    store.geometry.coordinates.lat = req.body.geometry.coordinates.lat;\n    store.geometry.coordinates.long = req.body.geometry.coordinates.long;\n    store.save(function (err){\n      if(err){\n        res.send(err);\n      }\n      res.json({message:\"Store info updated\"});\n    });\n  });\n});\n\n//DELETE 'v1/store/:id'\napi.delete('/:id', authenticate,(req, res) => {\n  Store.findById(req.params.id, (err, store) => {\n    if(err){\n      res.json({message:\"NO DELETED BAD ID\"});\n      return;\n    }\n    if (store === null){\n      res.json({message:\"STORE NOT FOUND\"});\n      return;\n    }\n    Store.remove({\n      _id: req.params.id\n    },(err, store) => {\n      if(err){\n        res.send(err);\n      }\n      res.json({message:\"Store removed\"});\n    });\n  });\n});\n\n//add a promo to an specific store id 'v1/store/promo/add/:id'\napi.post('/promo/add/:id', authenticate, (req, res)=>{\n  Store.findById(req.params.id, (err, store)=>{\n    if(err){\n      res.send(err);\n    }\n    var myDate = new Date();\n    let newPromo = new Promo();\n    newPromo.title = req.body.title;\n    newPromo.text = req.body.text;\n    newPromo.active = req.body.active;\n    newPromo.startDate = Date();\n    newPromo.endDate = myDate.setDate(myDate.getDate()+30);\n    newPromo.store = store._id;\n\n    newPromo.save((err, promo) =>{\n      if(err){\n        res.send(err);\n      }\n      store.promos.push(newPromo);\n      store.save(err => {\n        if(err){\n          res.send(err);\n        }\n        res.json({message: 'Promo added to the store'});\n      });\n    });\n  });\n});\n\n//get promos for an specific store id\n// 'v1/store/promos/:id'\napi.get('/promos/:id', authenticate,(req, res) => {\n  Promo.find({store: req.params.id}, (err, promos)=>{\n    if(err){\n      res.send(err);\n    }\n    res.json(promos);\n  });\n});\n\n//update a promo 'v1/store/promos/:id'\napi.put('/promos/:id', authenticate, (req, res)=>{\n  Promo.find({promos: req.params.id}, (err, promos)=>{\n    if(err){\n      res.send(err);\n    }\n    promos.title = req.body.title;\n    promos.text = req.body.text;\n  });\n});\n\n  return api;\n}\n"]}